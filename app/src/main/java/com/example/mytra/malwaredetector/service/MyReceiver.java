package com.example.mytra.malwaredetector.service;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.util.Log;


import com.example.mytra.malwaredetector.MainActivity;
import com.example.mytra.malwaredetector.utils.Application;
import com.example.mytra.malwaredetector.utils.Permission;
import com.example.mytra.malwaredetector.utils.Utils;

import java.io.Serializable;
import java.util.ArrayList;

import static com.example.mytra.malwaredetector.utils.Utils.convertStringToArray;
import static com.example.mytra.malwaredetector.utils.Utils.getID;
import static com.example.mytra.malwaredetector.utils.Utils.listPermission;
// Event when a new app is installed

public class MyReceiver extends BroadcastReceiver {
    String transaction;
    ArrayList<Integer> list;

    public MyReceiver() {
    }

    @Override
    public void onReceive(Context context, Intent intent) {
        list = new ArrayList<Integer>();
        ArrayList<Permission> listPermissions = Utils.getListPermission(context);
        PackageManager pm = context.getPackageManager();
        String packageName = intent.getDataString();
        // cut "package:"
        String str = packageName.substring(8);
       // Log.d("PackageMyyy:", str);

        try {
            PackageInfo pi = pm.getPackageInfo(str, PackageManager.GET_PERMISSIONS);
            String[] permission = pi.requestedPermissions;
            StringBuilder sb = new StringBuilder();
            int[] temp = null;
            int k = 0;
            if (permission != null) {
                temp = new int[permission.length];
                for (String s : permission) {
                   // Log.d("ahihi", s);
                    int id = getID(listPermissions, s);
                    if (id != -1) {
                        sb.append(id + " ");
                    }

                }
            }
            ApplicationInfo ai = pm.getApplicationInfo(str, 0);
            Application app;
            int[] list = convertStringToArray(sb.toString());
//            if (ai != null)
//                app = new Application(list, pm.getApplicationLabel(ai).toString());
//            else
            app = new Application(list, str);

            // direct to main activity when a new app is installed
            Intent i = new Intent(context, MainActivity.class);
            i.putExtra("app", (Serializable) app);
            i.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
            i.putExtra("install",true);
            context.startActivity(i);
            transaction = sb.toString();

        } catch (PackageManager.NameNotFoundException e) {
            e.printStackTrace();
        }
        if (transaction != null)
            Log.i("transaction: ", transaction);
    }

}
